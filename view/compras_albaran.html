{include="header"}

{if="$fsc->albaran"}
{if="$fsc->albaran->ptefactura"}
<script type="text/javascript" src="{$fsc->get_js_location('nueva_compra.js')}"></script>
<script type="text/javascript" src="plugins/facturacion_base/view/js/calendario_one.js"></script>
<script type="text/javascript">
   numlineas = {function="count($fsc->albaran->get_lineas())"};
   fs_nf0 = {#FS_NF0#};
   all_impuestos = {function="json_encode($fsc->impuesto->all())"};
   all_series = {function="json_encode($fsc->serie->all())"};
   proveedor = {function="json_encode($fsc->proveedor_s)"};   
   subcuentas = {function="json_encode($fsc->view_subcuen)"};
   subcuentas_c = {function="json_encode($fsc->view_subcuen_dev)"};
   nueva_compra_url = '{$fsc->nuevo_albaran_url}';
   kiwimaru_url = '{#FS_COMMUNITY_URL#}/index.php?page=kiwimaru';
   precio_compra = '{#FS_PRECIO_COMPRA#}';
   
   {if="$fsc->empresa->recequivalencia"}
   tiene_recargo = true;
   {/if}
   
   $(document).ready(function() {
      $("#numlineas").val(numlineas);
      usar_serie();
      recalcular();
      $("#ac_proveedor").autocomplete({
         serviceUrl: nueva_compra_url,
         paramName: 'buscar_proveedor',
         onSelect: function (suggestion) {
            if(suggestion)
            {
               if(document.f_albaran.proveedor.value != suggestion.data && suggestion.data != '')
               {
                  document.f_albaran.proveedor.value = suggestion.data;
                  usar_proveedor(suggestion.data);
               }
            }
         }
      });
   });
</script>
{else}
<script type="text/javascript">
   $(document).ready(function() {
      {if="$fsc->albaran->totalrecargo==0"}
      $(".recargo").hide();
      {/if}
      {if="$fsc->albaran->totalirpf==0"}
      $(".irpf").hide();
      {/if}
   });
</script>
{/if}
<script type="text/javascript">
   $(document).ready(function() {
      $("#b_imprimir").click(function(event) {
         event.preventDefault();
         $("#modal_imprimir_albaran").modal('show');
      });
      $("#b_enviar").click(function(event) {
         event.preventDefault();
         $("#modal_enviar").modal('show');
         document.enviar_email.email.select();
      });
      $("#b_eliminar").click(function(event) {
         event.preventDefault();
         $("#modal_eliminar").modal('show');
      });
      $("#b_genfactura").click(function(event) {
	  if(guarfact_verif()== true){
         event.preventDefault();
         $("#modal_genfactura").modal('show');}
      });	  
   });
   
    function rellenar(estado,val1,cant){
	cadcero='';
	for(i=0;i<(cant-val1.length);i++){
	cadcero+='0';
	}
	estado.value=cadcero+val1;
	}
	
	
	
	function verificar_factura()
   {

 var existefact = 0;
 {loop="$fsc->verif_factura"};
 if( document.getElementById('ac_proveedor').value == '{$value->nombre}')
 {
 	if( document.getElementById('comprobante').value+'/'+document.getElementById('numcorto').value+'-'+document.getElementById('numlargo').value == '{$value->numproveedor}')
	 {
	  	
	  var existefact = 1;  	 
	  }
 }
 {/loop}
   
 	  var a=document.getElementById('numcorto').value;
	  a=a.trim();
	  if(a.length!=4 || a=='0000')alert('Debe completar el campo de 4 digitos');
	  else
	  {
		  var a=document.getElementById('numlargo').value;
		  a=a.trim();
		  if(a.length!=8 || a=='00000000')alert('Debe completar el campo de 8 digitos');
		  else
		  {
			  if(existefact == 1)
			  {
			  alert('La factura ya existe!');
			  }
			  else 
				{
					document.f_albaran.numfactproveedor.value = document.getElementById('comprobante').value+'/'+document.getElementById('numcorto').value+'-'+document.getElementById('numlargo').value;
					document.getElementById('facturar').value = 'TRUE'
					return document.f_albaran.submit();
				}
		  }
	  }
	   
   }
   
   
</script>

<form name="f_albaran" action="{$fsc->albaran->url()}" method="post" class="form">
   <input type="hidden" name="idalbaran" value="{$fsc->albaran->idalbaran}"/>
   <input type="hidden" name="proveedor" value="{$fsc->albaran->codproveedor}"/>
   <input type="hidden" id="numlineas" name="numlineas" value="0"/>
   <input type="hidden" name="autorizar_factura" value="{$fsc->autorizar_factura}"/>
    <div class="container-fluid">
      <div class="row" style="margin-top: 10px;">
        <div class="col-xs-10">
			 <a class="btn btn-sm btn-default hidden-xs" href="{$fsc->url()}" title="Recargar la página">
               <span class="glyphicon glyphicon-refresh"></span>
            </a>

			{loop="$fsc->extensions"}
            {if="$value->type=='button'"}
			  <a href="index.php?page={$value->from}&id={$fsc->albaran->idalbaran}{$value->params}" class="btn btn-sm btn-default">
			{$value->text}
			</a>
            {/if}
            {/loop}
			{if="$fsc->autorizar_factura==1"}
            {if="$fsc->albaran->ptefactura"}
				<a id="b_genfactura" class="btn btn-sm btn-default" href="#">
					  <span class="glyphicon glyphicon-paperclip"></span>
					  <span class="hidden-xs">&nbsp; Generar Factura</span>
				</a>
            {else}
				<a class="btn btn-sm btn-info text-capitalize" href="{$fsc->albaran->factura_url()}">
				   <span class="glyphicon glyphicon-eye-open"></span>
				   <span class="hidden-xs">&nbsp; Ver Factura</span>
				</a>
            {/if}{/if}
			</div>
			<div >
			
			<button class="btn btn-sm btn-primary" type="button" onclick="guarfact()">
               <span class="glyphicon glyphicon-floppy-disk"></span> &nbsp; Guardar...
            </button>
			<a id="b_eliminar" class="btn btn-sm btn-danger" href="#">
                <span class="glyphicon glyphicon-trash"></span>
                <span class="hidden-sm hidden-xs">&nbsp; Eliminar</span>
            </a>

		
  		</div>
	  </div>
	</div>
   
   
   
   
   
   <div class="container-fluid">
		<div class="row">
         <div class="col-sm-4">		 
            <h3 style="margin-top: 1px;">
			{if="$fsc->autorizar_factura==1"}
			<a href="{$fsc->url_retorno()}">{#FS_FACTURAS#}</a>&nbsp;/
			{else}
			<a href="{$fsc->ppage->url()}">{#FS_ALBARANES#}</a>&nbsp;/
			{/if}
            <a href="{$fsc->proveedor_s->url()}">{$fsc->albaran->nombre}</a>
            </h3>
			 <div>
			   {if="$fsc->agente"}
			   <p>
			   <span class="text-capitalize">{#FS_ALBARAN#}</span> creado por
			   <a href="{$fsc->agente->url()}">{$fsc->agente->get_fullname()}</a>.
			   </p>
			   {else}
			   <p>Sin datos de qué empleado ha creado este {#FS_ALBARAN#}.</p>
			   {/if}
			 </div>
         </div>
		 <div class="col-sm-2">			
				  {$compr=substr($fsc->albaran->numremito, 2)}
				  {if="substr($fsc->albaran->numremito, 0,1)=='B'"}<label style="font:bold;font-size:18px">FACTURA B :</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='F'"}<label style="font:bold;font-size:18px">FACTURA C :</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='R'"}<label style="font:bold;font-size:18px">REMITO :</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='T'"}<label style="font:bold;font-size:18px">TICKET FACTURA:</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='Q'"}<label style="font:bold;font-size:18px">TICKET CRÉDITO:</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='C'"}<label style="font:bold; font-size:18px">NOTA DE CRÉDITO :</label>{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='D'"}<label style="font:bold;font-size:18px">NOTA DE DÉBITO :</label>{/if}		
				  {$tipcompr=substr($fsc->albaran->numremito, 0,1)}
				  {$numcompr=substr($fsc->albaran->numremito, 2)}
				  
			<input type="hidden" name="tipo_com" value="{$tipcompr}"/>	
			<input type="hidden" name="tipo" value="{$tipcompr}"/>
			<input type="text" name="comprobantenum" id="comprobantenum" class="form-control" style="font-size:18px;" readonly="true" value="{$numcompr}" />
		 </div>

		  <div class="col-sm-2">
            <div class="form-group" style="font:bold;font-size:18px">
               Fecha:
			   {if="$fsc->albaran->ptefactura"}
               <input type="text" name="fecha" id="fecha" class="form-control calendario"  data-date-format="dd-mm-yyyy"  value="{$fsc->albaran->fecha}" autocomplete="off" maxlength="10"/>
			   {else}
               <div class="form-control">{$fsc->albaran->fecha}</div>
			   {/if}
			</div>
		</div>
        <div class="col-sm-2">
            <div class="form-group" style="font:bold;font-size:18px">
               Hora:
               <input type="text" name="hora" class="form-control" value="{$fsc->hour()}" autocomplete="off"/>
            </div>
         </div>
      </div>
	  
	     			{if="$fsc->autorizar_factura==1"}
   	  				 <div class="col-sm-2">
					 <div class="form-group" style="font:bold;font-size:12px; width:210px">
					&nbsp;&nbsp;&nbsp;&nbsp;CAI :&nbsp;&nbsp;<input type="text" class="form-control"  id="cai" name="cai" value="{$fsc->albaran->cai}" />
					</div></div>
					<div class="col-sm-3">
					  <div class="form-group" style="font:bold;font-size:12px">
					&nbsp;&nbsp;Vence :&nbsp;&nbsp;<input type="text" id="caivence" name="caivence" class="form-control calendario"  data-date-format="dd-mm-yyyy" style="width:150px" {if="strtotime($fsc->albaran->caivence) > strtotime('01-01-2000')"}  value="{$fsc->albaran->caivence}"{else}value="" {/if} maxlength="10" />
					</div></div>
					{else}
					<input type="hidden" name="cai" value="{$fsc->albaran->cai}"/>
					<input type="hidden" name="caivence" value="{$fsc->albaran->caivence}"/>
					{/if}
	  
	  
	  
	  
	  
   </div>


   			   <input type="hidden" name="ac_proveedor" id="ac_proveedor" value="{$fsc->albaran->nombre}" placeholder="Buscar" autocomplete="off"/>          
               <input type="hidden" name="numproveedor" value="{$fsc->albaran->numremito}"/>
			   <input type="hidden"name="numproveedor" value="{$fsc->albaran->numproveedor}"/>
   <div role="tabpanel">
      <ul class="nav nav-tabs" role="tablist">
         <li role="presentation" class="active">
            <a href="#lineas_a" aria-controls="lineas_a" role="tab" data-toggle="tab">
               <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
               <span class="hidden-xs">&nbsp; Líneas</span>
            </a>
         </li>
		 {if="$fsc->autorizar_factura"}

         {loop="$fsc->extensions"}
            {if="$value->type=='tab'"}
            <li role="presentation">
               <a href="#ext_{$value->name}" aria-controls="ext_{$value->name}" role="tab" data-toggle="tab">{$value->text}</a>
            </li>
            {/if}
         {/loop}
		 {/if}
      </ul>
      <div class="tab-content">
         <div role="tabpanel" class="tab-pane active" id="lineas_a">
            <div class="table-responsive">
               {if="$fsc->albaran->ptefactura"}
               <table class="table table-condensed">
                  <thead>
                     <tr>
                        <th class="text-left" width="180">Referencia</th>
                        <th class="text-left" width="480">Descripción</th>
						{if="$fsc->autorizar_factura==1"}
						<th class="text-left">Subcuentas</th>
						{else}
						<th class="text-left"></th>
						{/if}
                        <th class="text-left" width="90">Cantidad</th>
                        <th width="60"></th>
                        <th class="text-left" width="110">Precio</th>
                        <th class="text-left" width="90">Dto. %</th>
                        <th class="text-left" width="130">Neto</th>
                        <th class="text-left" width="140">Total</th>
                     </tr>
                  </thead>
				  {if="$fsc->autorizar_factura==1"}
                  <tbody id="lineas_albaran">
				  {else}
				  <tbody id="lineas_albaran1">
				  {/if}
                  {loop="$fsc->albaran->get_lineas()"}
                     <tr id="linea_{$counter}">
                        <td>
                           <input type="hidden" name="idlinea_{$counter}" value="{$value->idlinea}"/>
                           <input type="hidden" name="referencia_{$counter}" value="{$value->referencia}"/>
                           <div class="form-control">
                              {if="$value->idlineapedido"}
                              <a target="_blank" href="index.php?page=compras_pedido&id={$value->idpedido}" title="ver {#FS_PEDIDO#}">
                                 <span class="glyphicon glyphicon-paperclip" aria-hidden="true"></span>
                              </a> &nbsp;
                              {/if}
                              <a target="_blank" href="{$value->articulo_url()}">{$value->referencia}</a>
                           </div>
                        </td>
                        <td><textarea class="form-control" name="desc_{$counter}" id="desc_{$counter}" rows="1" onclick="this.select()">{$value->descripcion}</textarea></td>
						<td>
						{if="$fsc->autorizar_factura==1"}
						<select name="subcuenta_{$counter}" id="subcuenta_{$counter}" class="form-control text-right" style='width:200px; font-size:12px'>
					 <option value='{$value->codsubcuenta}/{$value->subcuentadesc}%{$value->idsubcuenta}' selected="selected" >{$value->subcuentadesc}</option>
					 {loop="$fsc->view_subcuen"}
					 <option value='{$value->codsubcuenta}/{$value->descripcion}%{$value->idsubcuenta}' >{$value->descripcion}</option>
					 {/loop}
	 					</select>
						{/if}
						</td>
                        <td>
                           <input type="number" step="any" id="cantidad_{$counter}" class="form-control text-right" name="cantidad_{$counter}"
                                  value="{$value->cantidad}" onchange="recalcular()" onkeyup="recalcular()" autocomplete="off" value="1"/>
                        </td>
                        <td>
                           <button class="btn btn-sm btn-danger" type="button" onclick="$('#linea_{$counter}').remove();recalcular();">
                              <span class="glyphicon glyphicon-trash"></span>
                           </button>
                        </td>
                        <td>
                           <input type="text" class="form-control text-right" id="pvp_{$counter}" name="pvp_{$counter}" value="{$value->pvpunitario}"
                                  onkeyup="recalcular()" onclick="this.select()" autocomplete="off"/>
                        </td>
                        <td>
                           <input type="text" id="dto_{$counter}" name="dto_{$counter}" value="{$value->dtopor}" class="form-control text-right"
                                  onkeyup="recalcular()" onclick="this.select()" autocomplete="off"/>
                        </td>
                        <td>
                           <input type="text" class="form-control text-right" id="neto_{$counter}" name="neto_{$counter}"
                                 readonly="true" style="font-weight: bold; background-color:#FFFFFF"    onchange="ajustar_neto()" onclick="this.select()" autocomplete="off"/>
                        </td>
						<input type="hidden" name="iva_{$counter}" id="iva_{$counter}" value="0"  />                                               
                       
                        
                           <input type="hidden" class="form-control text-right" id="recargo_{$counter}" name="recargo_{$counter}" value="{$value->recargo}"
                                  onchange="recalcular()" onclick="this.select()" autocomplete="off"/>
                     
                        
                           <input type="hidden" class="form-control text-right" id="irpf_{$counter}" name="irpf_{$counter}" value="{$value->irpf}"
                             onchange="recalcular()" onclick="this.select()" autocomplete="off"/>
                       
                        <td>
                           <input type="text" class="form-control text-right" id="total_{$counter}" name="total_{$counter}"
                                style="font-weight: bold; background-color:#FFFFFF;"    onchange="ajustar_total()" onclick="this.select()" autocomplete="off"/>
                        </td>
						<td> <input type="button" value="A" onclick="ajustar_total()"/></td>
                     </tr>
                     {/loop}
                  </tbody>
                  <tbody>
                     <tr class="bg-info">
                        <td><input id="i_new_line" class="form-control" type="text" placeholder="Buscar para añadir..." autocomplete="off"/></td>
                        <td>
                           <a href="#" class="btn btn-sm btn-default" title="Añadir sin buscar" onclick="return add_linea_libre()">
                              <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                           </a>
                        </td>
						<td></td>
                        <td colspan="4" class="text-right">Totales:</td>
                        <td><div id="aneto" class="form-control text-right" style="font-weight: bold;">{$fsc->show_numero(0)}</div></td>

                     
                        <td>
                           <input type="text" name="atotal" id="atotal" class="form-control text-right" 
                                 readonly="true" style="font-weight: bold; background-color:#FFFFFF"   value="0" onchange="recalcular()" autocomplete="off"/>
                        </td>
                     </tr>

                  </tbody>
               </table>
               {else}
               <table class="table table-hover">
                  <thead>
                     <tr>
                        <th class="text-left">Artículo</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Precio</th>
                        <th class="text-right">Dto</th>
                        <th class="text-right">Neto</th>
                        <th class="text-right">Total</th>
                     </tr>
                  </thead>
                  {loop="$fsc->albaran->get_lineas()"}
                  <tr{if="$value->cantidad<=0"} class="bg-warning"{/if}>
                     <td>
                        {if="$value->idlineapedido"}
                        <a target="_blank" href="index.php?page=compras_pedido&id={$value->idpedido}" title="ver {#FS_PEDIDO#}">
                           <span class="glyphicon glyphicon-paperclip" aria-hidden="true"></span>
                        </a> &nbsp;
                        {/if}
                        <a href="{$value->articulo_url()}">{$value->referencia}</a> {$value->descripcion}
                     </td>
                     <td class="text-right">{$value->cantidad}</td>
                     <td class="text-right">{$fsc->show_precio($value->pvpunitario, $fsc->albaran->coddivisa)}</td>
                     <td class="text-right">{$fsc->show_numero($value->dtopor, 2)} %</td>
                     <td class="text-right">{$fsc->show_precio($value->pvptotal, $fsc->albaran->coddivisa)}</td>
                     <td class="text-right">{$fsc->show_precio($value->total_iva(), $fsc->albaran->coddivisa)}</td>
                  </tr>
                  {/loop}
                  <tr>
                     <td colspan="4"></td>
                     <td class="text-right"><b>{$fsc->show_precio($fsc->albaran->neto, $fsc->albaran->coddivisa)}</b></td>
                    
                     
              
                     <td class="text-right"><b>{$fsc->show_precio($fsc->albaran->total, $fsc->albaran->coddivisa)}</b></td>
                  </tr>
               </table>
               {/if}
            </div>
	<div class="container-fluid">
      <div class="row">
         <div class="col-lg-12">
            <div class="form-group">
               Observaciones:
               <textarea class="form-control" name="observaciones" rows="3">{$fsc->albaran->observaciones}</textarea>
            </div>
         </div>
      </div>
   </div>
         </div>
         {if="$fsc->albaran->ptefactura"}
         <div role="tabpanel" class="tab-pane" id="opciones">
            <div class="container-fluid" style="margin-top: 10px;">
               <div class="row">
                  <div class="col-sm-2">
                     <div class="form-group">
                        <a href="{$fsc->serie->url()}">Serie</a>:
                        <select class="form-control" name="serie" id="codserie" onchange="usar_serie();recalcular();">
                        {loop="$fsc->serie->all()"}
                           {if="$value->codserie==$fsc->albaran->codserie"}
                           <option value="{$value->codserie}" selected="selected">{$value->descripcion}</option>
                           {else}
                           <option value="{$value->codserie}">{$value->descripcion}</option>
                           {/if}
                        {/loop}
                        </select>
                     </div>
                  </div>
                  <div class="col-sm-3">
                     <div class="form-group">
                        <a href="{$fsc->forma_pago->url()}">Forma de pago</a>:
                        <select name="forma_pago" class="form-control">
                           {loop="$fsc->forma_pago->all()"}
                           <option value="{$value->codpago}"{if="$value->codpago==$fsc->albaran->codpago"} selected="selected"{/if}>{$value->descripcion}</option>
                           {/loop}
                        </select>
                     </div>
                  </div>
                  <div class="col-sm-2">
                     <div class="form-group">
                        <a href="{$fsc->divisa->url()}">Divisa</a>:
                        <select name="divisa" class="form-control">
                        {loop="$fsc->divisa->all()"}
                           {if="$value->coddivisa==$fsc->albaran->coddivisa"}
                           <option value="{$value->coddivisa}" selected="selected">{$value->descripcion}</option>
                           {else}
                           <option value="{$value->coddivisa}">{$value->descripcion}</option>
                           {/if}
                        {/loop}
                        </select>
                     </div>
                  </div>
                  <div class="col-sm-3">
                     <div class="form-group">
                        Tasa de conversión a €
                        <input type="text" name="tasaconv" class="form-control" placeholder="{$fsc->albaran->tasaconv}" value="{$fsc->albaran->tasaconv}" autocomplete="off"/>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         {/if}
         {loop="$fsc->extensions"}
            {if="$value->type=='tab'"}
            <div role="tabpanel" class="tab-pane" id="ext_{$value->name}">
               <iframe src="index.php?page={$value->from}{$value->params}&id={$fsc->albaran->idalbaran}" width="100%" height="600" frameborder="0"></iframe>
            </div>
            {/if}
         {/loop}
      </div>
   </div>
   
   
   
   
    <div class="modal fade" id="modal_genfactura">
      <div class="modal-dialog">
         <div class="modal-content">
		  <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
               <h4 class="modal-title">Colocar Nº de Comprobante</h4>
            </div>
            <div class="modal-body">
               <div class="form-group">
                  <div class="input-group">
				  <input type="hidden" name="facturar" id="facturar" value="FALSE"/>
                     <input type="hidden" name="nombreproveedor" id="nombreproveedor" value="{$fsc->albaran->nombre}" />
					 <input type="hidden" name="proveedor" id="proveedor" value="{$fsc->albaran-> codproveedor}" />
					 <input type="hidden" name="delete" value="{$fsc->albaran->idalbaran}"/>
				   <input type="hidden" name="numfactproveedor" id="numfactproveedor" value="" />
				   <input type="hidden" name="autorizar_factura" value="{$fsc->autorizar_factura}"/>
                    Proveedor :<strong style="size:14px"> &nbsp;&nbsp;{$fsc->albaran->nombre}</strong>
                  </div>
				  <br />
				  <script>
				  {$compr=substr($fsc->albaran->numremito, 2)}
				  {if="substr($fsc->albaran->numremito, 0,1)=='B'"}{$comp_doc ='FACTURA B'}{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='F'"}{$comp_doc ='FACTURA C'}{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='T'"}{$comp_doc ='TICKET FACTURA'}{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='Q'"}{$comp_doc ='TICKET CRÉDITO'}{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='C'"}{$comp_doc ='NOTA DE CRÉDITO'}{/if}
				  {if="substr($fsc->albaran->numremito, 0,1)=='D'"}{$comp_doc ='NOTA DE DÉBITO'}{/if}	
				  {substr($fsc->albaran->numremito, 0,1)}	
				  {$doc_letra = $tipcompr=substr($fsc->albaran->numremito, 0,1)}
				  {$numcompr=substr($fsc->albaran->numremito, 2);}
				  {$numcompr_corto = substr($numcompr,0,4);}
				  {$numcompr_largo = substr($numcompr,5);}
				  </script>
				<div class="form-group">
				 <table class="table table-condensed">
                  <thead>
                     <tr>
                        <th class="text-left">Tipo Comprobante</th>
                        <th class="text-left"> </th>
						
                        <th class="text-left">Número de comprobante del Proveedor</th>
                     </tr>
                  </thead>
				  <tbody>
                     <tr class="bg-info">
					{if="substr($fsc->albaran->numremito, 0,1)=='R'"} 
                        <td>
					<select name="comprobante" id="comprobante" class="form-control" style="width:auto"  >
						   <option value="B" selected="selected">FACTURA B</option>
						   <option value="F" >FACTURA C</option>
						   <option value="T" >TICKET FACTURA</option>
						   <option value="Q" >TICKET CRÉDITO</option>
						   <option value="C" >NOTA DE CRÉDITO</option>
						   <option value="D" >NOTA DE DÉBITO</option>
						</select>	
						</td>
						<td>
						<input id="numcorto" name="numcorto" class="form-control" style="width:60px" type="text" autocomplete="on" maxlength="4" onblur="rellenar(this,this.value,4)" onClick="this.setSelectionRange(0, this.value.length)" />
						</td>
						
						<td>
						<input id="numlargo" name="numlargo" class="form-control" style="width:auto" type="text" autocomplete="on" maxlength="8"  onblur="rellenar(this,this.value,8)" onClick="this.setSelectionRange(0, this.value.length)" />
						</td>
                      {else}
					<td>
					<select name="comprobante" id="comprobante" class="form-control" style="width:auto"  >
						   <option value="{$doc_letra}" selected="selected">{$comp_doc}</option>
						   <option value="B" >FACTURA B</option>
						   <option value="F" >FACTURA C</option>
						   <option value="T" >TICKET FACTURA</option>
						   <option value="Q" >TICKET CRÉDITO</option>
						   <option value="C" >NOTA DE CRÉDITO</option>
						   <option value="D" >NOTA DE DÉBITO</option>
						</select>	
						</td>
						<td>
						<input id="numcorto" name="numcorto" class="form-control" style="width:60px" type="text" autocomplete="on" maxlength="4" onblur="rellenar(this,this.value,4)" onClick="this.setSelectionRange(0, this.value.length)" value="{$numcompr_corto}" />
						</td>
						
						<td>
						<input id="numlargo" name="numlargo" class="form-control" style="width:auto" type="text" autocomplete="on" maxlength="8"  onblur="rellenar(this,this.value,8)" onClick="this.setSelectionRange(0, this.value.length)"  value="{$numcompr_largo}" />
						</td>
				  {/if}
					  
                     </tr>
                  </tbody>
               </table>
               	</div>
				 <span class="input-group-btn">
				
                        <button class="btn btn-primary" id="continuarfact" type="button"  onclick="verificar_factura();">
                           <span class="glyphicon glyphicon-share-alt">Continuar</span>
                        </button>
                     </span>
			   
               </div>
            </div>
         </div>
      </div>
   </div>
   

</form>

<div class="modal" id="modal_articulos">
   <div class="modal-dialog" style="width: 99%; max-width: 1000px;">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 class="modal-title">Buscar artículos</h3>
         </div>
         <div class="modal-body">
            <form id="f_buscar_articulos" name="f_buscar_articulos" action="{$fsc->url()}" method="post" class="form">
               <input type="hidden" name="codproveedor" value="{$fsc->albaran->codproveedor}"/>
               <div class="container-fluid">
                  <div class="row">
                     <div class="col-sm-4">
                        <div class="input-group">
                           <input class="form-control" type="text" name="query" autocomplete="off"/>
                           <span class="input-group-btn">
                              <button class="btn btn-primary" type="submit">
                                 <span class="glyphicon glyphicon-search"></span>
                              </button>
                           </span>
                        </div>
                     </div>
                     <div class="col-sm-4">
                        <select class="form-control" name="codfamilia" onchange="buscar_articulos()">
                           <option value="">Cualquier familia</option>
                           <option value="">------</option>
                           {loop="$fsc->familia->all()"}
                           <option value="{$value->codfamilia}">{$value->nivel}{$value->descripcion}</option>
                           {/loop}
                        </select>
                     </div>
                     <div class="col-sm-4">
                        <select class="form-control" name="codfabricante" onchange="buscar_articulos()">
                           <option value="">Cualquier fabricante</option>
                           <option value="">------</option>
                           {loop="$fsc->fabricante->all()"}
                           <option value="{$value->codfabricante}">{$value->nombre}</option>
                           {/loop}
                        </select>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col-sm-2">
                        <div class="checkbox-inline">
                           <label>
                              <input type="checkbox" name="con_stock" value="TRUE" onchange="buscar_articulos()"/>
                              sólo con stock
                           </label>
                        </div>
                     </div>
                     <div class="col-sm-3">
                        <div class="checkbox-inline">
                           <label>
                              <input type="checkbox" name="solo_proveedor" value="TRUE" onchange="buscar_articulos()"/>
                              sólo de este proveedor
                           </label>
                        </div>
                     </div>
                  </div>
               </div>
            </form>
         </div>
         <ul class="nav nav-tabs" id="nav_articulos" style="display: none;">
            <li id="li_mis_articulos">
               <a href="#" id="b_mis_articulos">Mi catálogo</a>
            </li>

            <li id="li_nuevo_articulo">
               <a href="#" id="b_nuevo_articulo">
                  <span class="glyphicon glyphicon-plus"></span> &nbsp; Nuevo
               </a>
            </li>
         </ul>
         <div id="search_results"></div>
         <div id="kiwimaru_results"></div>
         <div id="nuevo_articulo" class="modal-body" style="display: none;">
            <form name="f_nuevo_articulo" action="{$fsc->url()}" method="post" class="form">
               <input type="hidden" name="codproveedor" value="{$fsc->proveedor_s->codproveedor}"/>
               <div class="container-fluid">
                  <div class="row">
                     <div class="col-sm-3">
                        <div class="form-group">
                           Referencia:
                           <input class="form-control" type="text" name="referencia" maxlength="18" autocomplete="off"/>
                        </div>
                     </div>
                     <div class="col-sm-3">
                        <div class="form-group">
                           Ref. Proveedor:
                           <input class="form-control" type="text" name="refproveedor" maxlength="25" autocomplete="off"/>
                        </div>
                     </div>
                     <div class="col-sm-6">
                        <div class="form-group">
                           Descripción:
                           <textarea name="descripcion" rows="1" class="form-control"></textarea>
                        </div>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col-sm-4">
                        <div class="form-group">
                           <a href="{$fsc->familia->url()}">Familia</a>:
                           <select name="codfamilia" class="form-control">
                              <option value="">Ninguna</option>
                              <option value="">-------</option>
                              {loop="$fsc->familia->all()"}
                              <option value="{$value->codfamilia}">{$value->nivel}{$value->descripcion}</option>
                              {/loop}
                           </select>
                        </div>
                     </div>
                     <div class="col-sm-4">
                        <div class="form-group">
                           <a href="{$fsc->fabricante->url()}">Fabricante</a>:
                           <select name="codfabricante" class="form-control">
                              <option value="">Ninguno</option>
                              <option value="">-------</option>
                              {loop="$fsc->fabricante->all()"}
                              <option value="{$value->codfabricante}">{$value->nombre}</option>
                              {/loop}
                           </select>
                        </div>
                     </div>
                     <div class="col-sm-4">
                        <div class="form-group">
                           <a href="{$fsc->impuesto->url()}">{#FS_IVA#}</a>:
                           <select name="codimpuesto" class="form-control">
                              {loop="$fsc->impuesto->all()"}
                              <option value="{$value->codimpuesto}"{if="$value->is_default()"} selected="selected"{/if}>{$value->descripcion}</option>
                              {/loop}
                           </select>
                        </div>
                     </div>
                  </div>
                  <div class="row">
                     <div class="col-sm-4">
                        <div class="form-group">
                           Precio compra:
                           <input type="text" name="coste" value="0" class="form-control" autocomplete="off"/>
                        </div>
                     </div>
                     <div class="col-sm-4">
                        <div class="form-group">
                           Precio venta:
                           <input type="text" name="pvp" value="0" class="form-control" autocomplete="off"/>
                           <div class="checkbox-inline">
                              <label>
                                 <input type="checkbox" name="publico" value="TRUE"/> Público
                              </label>
                           </div>
                        </div>
                     </div>
                     <div class="col-sm-4 text-right">
                        <br/>
                        <button class="btn btn-sm btn-primary" type="submit" onclick="new_articulo();return false;">
                           <span class="glyphicon glyphicon-floppy-disk"></span> &nbsp; Guardar y seleccionar
                        </button>
                     </div>
                  </div>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>

<div class="modal fade" id="modal_imprimir_albaran">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Imprimir {#FS_ALBARAN#}</h4>
         </div>
         <div class="modal-body">
            {loop="$fsc->extensions"}
               {if="$value->type=='pdf'"}
               <a href="index.php?page={$value->from}{$value->params}&id={$fsc->albaran->idalbaran}" target="_blank" class="btn btn-block btn-default">
                  <span class="glyphicon glyphicon-print"></span> &nbsp; {$value->from}{$value->params}&id={$fsc->albaran->idalbaran}
               </a>
               {/if}
            {/loop}
         </div>
      </div>
   </div>
</div>

<form class="form" role="form" name="enviar_email" action="{$fsc->url()}" method="post">
   <div class="modal" id="modal_enviar">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
               <h4 class="modal-title">Enviar {#FS_ALBARAN#}</h4>
            </div>
            <div class="modal-body">
               <div class="form-group">
                  Email del proveedor:
                  <input class="form-control" type="text" name="email" value="{$fsc->proveedor_s->email}" autocomplete="off"/>
               </div>
               <div class="form-group">
                  Mensaje:
                  <textarea class="form-control" name="mensaje" rows="6">Buenos días, le adjunto mi {#FS_ALBARAN#} {$fsc->albaran->codigo}.
{$fsc->empresa->email_firma}</textarea>
               </div>
               {loop="$fsc->extensions"}
                  {if="$value->type=='email'"}
                  <button class="btn btn-sm btn-primary" type="submit" onclick="this.disabled=true;this.form.action='index.php?page={$value->from}{$value->params}&id={$fsc->albaran->idalbaran}';this.form.submit();">
                     <span class="glyphicon glyphicon-send"></span> &nbsp; {$value->text}
                  </button>
                  {/if}
               {/loop}
            </div>
         </div>
      </div>
   </div>
</form>

<form action="{$fsc->ppage->url()}" method="post">
   <input type="hidden" name="delete" value="{$fsc->albaran->idalbaran}"/>
   <div class="modal fade" id="modal_eliminar">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
               <h3 class="modal-title">¿Realmente desea eliminar este {#FS_ALBARAN#}?</h3>
            </div>
            {if="$fsc->albaran->idfactura"}
            <div class="alert alert-warning">
               Hay una <b>factura</b> asociada que <b>será eliminada</b> junto con este {#FS_ALBARAN#}.
            </div>
            {/if}
            <div class="modal-footer">
               <div class="pull-left">
                  <label>
                     <input type="checkbox" name="stock" value="TRUE" checked="checked"/>
                     Actualizar el stock
                  </label>
               </div>
               <button class="btn btn-sm btn-danger" onclick="this.disabled=true;this.form.submit();">
                  <span class="glyphicon glyphicon-trash"></span> &nbsp; Eliminar
               </button>
            </div>
         </div>
      </div>
   </div>
</form>




{else}
<div class="thumbnail">
   <img src="view/img/fuuu_face.png" alt="fuuuuu"/>
</div>
{/if}

<script type="text/javascript">
  function guarfact()
{	

	if({$fsc->autorizar_factura} == 0 )
	{
	var aler = 0;	
	
	var numsub='';

				var f2 =document.getElementById('fecha').value;
				var d2 =f2.substr(0,2);
				var m2 =f2.substr(3,2);
				var y2 =f2.substr(6);
				var fe2 = new Date(y2,m2,d2);
				if( !isNaN(fe2) ) document.getElementById('fecha').value = d2+'-'+m2+'-'+y2;				 				
				else document.getElementById('fecha').value = "";
				
				fecha_fac = document.getElementById('fecha').value;
				if( fecha_fac.trim() == '' )
				{
				alert('Debe colocar la fecha de la factura');
				aler = 1;
				}
				
				numsub = document.getElementById('numlineas').value;
				var descr =''; 
				
				if( document.getElementById('atotal').value <= 0)
				{
				alert("El Total de la Factura no puede ser 0.00");
				aler = 1;
				}
				
				
				for(var i=0;i<(numsub);i++)
					{
					  if(document.getElementById('desc_'+i))
					  {
					 	descr = document.getElementById('desc_'+i).value;
					
					 	if( descr.trim() == '')
						{
						alert("La descripción de una linea no puede estar vacía");
						aler = 1;
						}
					 
						if( document.getElementById('total_'+i).value <= 0 )
						{
						alert("El Total de una linea no puede ser 0.00");
						aler = 1;
						}
						if( document.getElementById('atotal').value <= 0 || document.getElementById('atotal').value == 'NaN' )
				{
				alert("El Total de la Factura no puede ser 0.00");
				aler = 1;
				}
					  }
					}
			if( aler == 0) document.f_albaran.submit();
				else return;
		}
		else
		{
			var aler = 0;	
			var descr ='';
			var numsub='';

			var ban = 0;
				var f1 =(document.getElementById('caivence').value);
				var f2 =document.getElementById('fecha').value;
															
				var d1 =f1.substr(0,2);
				var m1 =f1.substr(3,2);
				var y1 =f1.substr(6);
				
				var d2 =f2.substr(0,2);
				var m2 =f2.substr(3,2);
				var y2 =f2.substr(6);
				
				var fe1 = new Date(y1,m1,d1);
				var fe2 = new Date(y2,m2,d2);
												
				if( !isNaN(fe1) ) document.getElementById('caivence').value = d1+'-'+m1+'-'+y1;
				else document.getElementById('caivence').value = "";				
				if( !isNaN(fe2) ) document.getElementById('fecha').value = d2+'-'+m2+'-'+y2;				 				
				else document.getElementById('fecha').value = "";	
				
				fecha_fac = document.getElementById('fecha').value;
				if( fecha_fac.trim() == '' )
				{
				alert('Debe colocar la fecha de la factura');
				aler = 1;
				}
				
				if( fe1 < fe2 )
				{
				alert('La fecha CAI está vencida');
				aler = 1;
				}
				numsub = document.getElementById('numlineas').value;
				$caival = document.getElementById('cai').value;
				$caivenceval = document.getElementById('caivence').value;
				if( $caival.trim() == '' || $caivenceval.trim() == '' )
				{		
					alert("Debe completar el campo CAI y la fecha de vencimiento");
					aler = 1;
				}	 
				for(i=0;i<(numsub);i++)
					   {
					    if( document.getElementById('subcuenta_'+i))
							{
					   			if( document.getElementById('subcuenta_'+i).value == 'null/%0' || document.getElementById('subcuenta_'+i).value == 'null/%' || document.getElementById('total_'+i).value == 0 || document.getElementById('subcuenta_'+i).value == '0/%'  || document.getElementById('subcuenta_'+i).value == '/%'  || document.getElementById('subcuenta_'+i).value == '/%0' || document.getElementById('subcuenta_'+i).value == '0/0%0'  || document.getElementById('subcuenta_'+i).value == '' ){ ban = 1;}
							}
							
						if(document.getElementById('desc_'+i))
						  {
							descr = document.getElementById('desc_'+i).value;
						
							if( descr.trim() == '')
							{
							alert("La descripción de una linea no puede estar vacía");
							aler = 1;
							}
						}	
							
														
					   }				
				if(ban == 1 ) 
				{
				alert("Falta completar el campo de SubCuenta o el Total de un Ítem es 0.00");
				aler =1;
				}												
				if( document.getElementById('atotal').value <= 0 || document.getElementById('atotal').value == 'NaN' )
				{
				alert("El Total de la Factura no puede ser 0.00");
				aler = 1;
				}
				if( aler == 0) document.f_albaran.submit();
				else return;
				
				
	
		
		
		
		}			
				
				
	
	}
	
	  function guarfact_verif()
{
	var aler = 0;	
			var descr ='';
			var numsub='';

				var ban = 0;
				var f1 =(document.getElementById('caivence').value);
				var f2 ='{$fsc->today()}';
				
								
				var d1 =f1.substr(0,2);
				var m1 =f1.substr(3,2);
				var y1 =f1.substr(6);
				
				var d2 =f2.substr(0,2);
				var m2 =f2.substr(3,2);
				var y2 =f2.substr(6);
				
				var fe1 = new Date(y1,m1,d1);
				var fe2 = new Date(y2,m2,d2);
				
				if( !isNaN(fe1) ) document.getElementById('caivence').value = d1+'-'+m1+'-'+y1;
				else document.getElementById('caivence').value = "";				
				if( !isNaN(fe2) ) document.getElementById('fecha').value = d2+'-'+m2+'-'+y2;				 				
				else document.getElementById('fecha').value = "";	
				
				fecha_fac = document.getElementById('fecha').value;
				if( fecha_fac.trim() == '' )
				{
				alert('Debe colocar la fecha de la factura');
				aler = 1;
				}
				
				if( fe1 < fe2 )
				{
				alert('La fecha CAI está vencida');
				aler = 1;
				}
				
				numsub = document.getElementById('numlineas').value;
				$caival = document.getElementById('cai').value;
				$caivenceval = document.getElementById('caivence').value;
				if( $caival.trim() == '' || $caivenceval.trim() == '' )
				{		
					alert("Debe completar el campo CAI y la fecha de vencimiento");
					aler = 1;
				}	 
				for(i=0;i<(numsub);i++)
					   {
					    if( document.getElementById('subcuenta_'+i))
							{
					   			if( document.getElementById('subcuenta_'+i).value == 'null/%0' || document.getElementById('subcuenta_'+i).value == 'null/%' || document.getElementById('total_'+i).value == 0 || document.getElementById('subcuenta_'+i).value == '0/%'  || document.getElementById('subcuenta_'+i).value == '/%'  || document.getElementById('subcuenta_'+i).value == '/%0' || document.getElementById('subcuenta_'+i).value == '0/0%0'  || document.getElementById('subcuenta_'+i).value == '' ){ ban = 1;}
							}
							
						if(document.getElementById('desc_'+i))
						  {
							descr = document.getElementById('desc_'+i).value;
						
							if( descr.trim() == '')
							{
							alert("La descripción de una linea no puede estar vacía");
							aler = 1;
							}
						}	
							
														
					   }				
				if(ban == 1 ) 
				{
				alert("Falta completar el campo de SubCuenta o el Total de un Ítem es 0.00");
				aler =1;
				}												
				if( document.getElementById('atotal').value <= 0)
				{
				alert("El Total de la Factura no puede ser 0.00");
				aler = 1;
				}
				if( aler == 0) return true;
				else return false;
				
	
	
}	
</script>	



{include="footer"}